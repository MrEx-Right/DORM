package exploitdb // <--- Package name must match the folder name

import (
	"encoding/csv"
	"fmt"
	"net/http"
	"strings"
	"sync"
	"time"
)

// Exploit Data Structure
type Exploit struct {
	ID          string
	Description string
}

// Global Variables (Live only within this package)
var (
	database []Exploit
	isLoaded bool
	mutex    sync.Mutex
)

// 1. DOWNLOAD DATABASE AND LOAD INTO RAM
func Load() error {
	mutex.Lock()
	defer mutex.Unlock()

	if isLoaded {
		return nil
	}

	fmt.Println("[*] Downloading Exploit-DB database (files_exploits.csv)...")

	url := "https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv"
	client := &http.Client{Timeout: 15 * time.Second}

	resp, err := client.Get(url)
	if err != nil {
		return fmt.Errorf("download error: %v", err)
	}
	defer resp.Body.Close()

	// CSV Reader
	reader := csv.NewReader(resp.Body)
	records, err := reader.ReadAll()
	if err != nil {
		return fmt.Errorf("CSV reading error: %v", err)
	}

	// Fill into RAM
	for i, record := range records {
		if i == 0 {
			continue
		} // Skip header
		if len(record) < 3 {
			continue
		}

		// ID and Description are enough for us
		database = append(database, Exploit{
			ID:          record[0],
			Description: strings.ToLower(record[2]), // Convert to lowercase for easy searching
		})
	}

	isLoaded = true
	fmt.Printf("[+] Exploit-DB Ready! %d records loaded into RAM.\n", len(database))
	return nil
}

// 2. SEARCH ENGINE
func Search(keywords string) []string {
	if !isLoaded {
		Load() // Load if not already loaded
	}

	keywords = strings.ToLower(keywords)
	var results []string
	count := 0

	// Scan thousands of records in RAM
	for _, item := range database {
		// If description contains the keyword (e.g., "apache 2.4")
		if strings.Contains(item.Description, keywords) {
			link := fmt.Sprintf("https://www.exploit-db.com/exploits/%s", item.ID)
			// Return result as a formatted string
			results = append(results, fmt.Sprintf("FOUND: %s\n   Link: %s", item.Description, link))

			count++
			if count >= 5 {
				break
			} // Show max 5 results
		}
	}

	return results
}
